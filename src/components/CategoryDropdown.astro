---
import { getCollection } from "astro:content";

import getCategoryTheme from "../utils/getCategoryTheme";

const posts = await getCollection("blog");

const uniqueCategories = [
    ...new Set(posts.map((post) => post.data.category).flat()),
];

const dropdownOptions = uniqueCategories
    .map((category) => ({
        name: category,
        theme: getCategoryTheme(category),
        url: `/categories/${category.toLowerCase()}`,
    }))
    .sort((a, b) => (a.name > b.name ? 1 : -1));
---

<script>
    document.addEventListener("DOMContentLoaded", function (event) {
        document.body.classList.remove("loading");
    });

    /* Dropdown */
    var dropdowns = document.querySelectorAll(".dropdown");
    for (var i = 0; i < dropdowns.length; i++) {
        dropdowns[i].addEventListener("click", function (e) {
            const target = e.target as HTMLElement;
            const dropdown = target.closest(".dropdown");
            if (dropdown) {
                dropdown.classList.toggle("active");
                dropdown
                    .querySelector(".dropdown-menu")
                    ?.classList.toggle("show");
            }
        });
        dropdowns[i].addEventListener("focusout", function (e) {
            const target = e.target as HTMLElement;
            target.classList.remove("active");
            target.querySelector(".dropdown-menu")?.classList.remove("show");
        });
    }

    var dropdownOptions = document.querySelectorAll(".dropdown-menu li");
    for (var i = 0; i < dropdownOptions.length; i++) {
        dropdownOptions[i].addEventListener("click", function (e) {
            const target = e.target as HTMLElement;
            window.location = target.dataset.url as unknown as Location;
        });
    }
</script>

<div class="dropdown mt1">
    <div
        class="select bg-white border-[#dfdfdf] dark:bg-[#1f1f1f] dark:text-[#ccc] dark:border-[#4e4e4e]"
    >
        <span>Filter by category</span>
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 16 16"
            ><g
                stroke-width="1"
                fill="none"
                stroke="#6d6d6d"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><polyline points="2 5.5 8 11.5 14 5.5"></polyline></g
            ></svg
        >
    </div>
    <ul
        class="dropdown-menu bg-white border-[#dfdfdf] dark:bg-[#1f1f1f] dark:text-[#ccc] dark:border-[#4e4e4e]"
    >
        <li data-url="/" class="hover:bg-[#f9f9f9] dark:hover:bg-[#2f2f2f]">
            <span class="category-color" style="background-color: #604df5"
            ></span>All posts
        </li>
        {
            dropdownOptions.map((option) => (
                <li
                    data-url={option.url}
                    class="hover:bg-[#f9f9f9] dark:hover:bg-[#2f2f2f]"
                >
                    <span class:list={["category-color", option.theme]} />
                    {option.name}
                </li>
            ))
        }
    </ul>
</div>

<style>
    .category-color {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 10px;
        margin-right: 0.25rem;
    }

    .dropdown .category-color {
        vertical-align: text-top;
        margin-right: 0.5rem;
    }

    .dropdown {
        width: 100%;
        max-width: 240px;
        display: inline-block;
        transition: all 0.3s ease;
        position: relative;
        font-size: 14px;
        height: 100%;
        text-align: left;
        border-radius: 5px;
    }
    .dropdown:focus {
        outline: none;
    }
    .dropdown .select {
        cursor: pointer;
        display: block;
        padding: 0.5rem;
        border-radius: 5px;
        box-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
        border-width: 1px;
        border-style: solid;
    }
    .dropdown .select > svg {
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        float: right;
        margin-top: 3px;
    }
    .dropdown:hover {
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .dropdown.active .select {
        border-radius: 5px 5px 0 0;
    }
    .dropdown.active .select > svg {
        transform: rotate(-180deg);
    }
    .dropdown .dropdown-menu {
        position: absolute;
        width: 100%;
        left: 0;
        margin-top: -1px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        border-width: 1px;
        border-style: solid;
        border-radius: 0 0 5px 5px;
        overflow: hidden;
        display: none;
        max-height: 144px;
        overflow-y: auto;
        z-index: 9;
    }
    .dropdown .dropdown-menu.show {
        display: block;
    }
    .dropdown .dropdown-menu li {
        padding: 0.5rem;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        margin-bottom: 0;
    }
    .dropdown .dropdown-menu {
        padding: 0;
        list-style: none;
    }
</style>
